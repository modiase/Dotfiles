#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
Usage: build-and-deploy-hermes.sh [-v|--verbose LEVEL] [-b|--build-only] [-h|--help]

Build hermes NixOS image and deploy to GCE via OpenTofu.

Options:
  -v, --verbose LEVEL   Verbosity level: 1 (debug logs), 2 (bash tracing + terraform trace)
  -b, --build-only      Only build the image, skip deployment
  -h, --help            Show this help message

Environment variables:
  PROJECT_ID  GCP project ID (default: modiase-infra)

Example:
  PROJECT_ID=modiase-infra ./bin/build-and-deploy-hermes.sh --verbose 1 --build-only
USAGE
}

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

export CI=1
export TERM=dumb
export NO_COLOR=${NO_COLOR:-false}

LOG_LEVEL=${LOG_LEVEL:-2}
COLOR_ENABLED=${COLOR_ENABLED:-true}
LOGGING_NO_PREFIX=${LOGGING_NO_PREFIX:-0}
source "$SCRIPT_DIR/lib.sh"
COLOR_CYAN="$COLOR_WHITE"

PROJECT_ID="${PROJECT_ID:-modiase-infra}"
DEST_URI="gs://modiase-infra/images/hermes-nixos-latest.tar.gz"
IMAGE_ATTR="nixosConfigurations.hermes.config.system.build.googleComputeImage"
FLAKE_URI="$REPO_ROOT"
REMOTE_HOST="herakles"
TF_VAR_FILE="$REPO_ROOT/infra/tofu.tfvars"
VERBOSE_LEVEL=0
BUILD_ONLY=false

TEMP=$(getopt -o v:bh --long verbose:,build-only,help -n "$0" -- "$@")
if [[ $? != 0 ]]; then
  usage
  exit 1
fi

eval set -- "$TEMP"

while true; do
  case "$1" in
    -v|--verbose)
      VERBOSE_LEVEL="$2"; shift 2;
      ;;
    -b|--build-only)
      BUILD_ONLY=true; shift;
      ;;
    -h|--help)
      usage; exit 0;
      ;;
    --)
      shift; break;
      ;;
    *)
      echo "Unknown argument: $1" >&2
      usage
      exit 1
      ;;
  esac
done

if [[ $VERBOSE_LEVEL -ge 2 ]]; then
  set -x
  export TF_LOG=TRACE
elif [[ $VERBOSE_LEVEL -ge 1 ]]; then
  export TF_LOG=DEBUG
fi

# Function to upload image to GCS
upload_to_gcs() {
  local local_path="$1"
  local dest_uri="$2"
  local project_id="$3"

  local tmpdir="$(mktemp -d)"
  trap 'rm -rf "$tmpdir"' RETURN

  # Copy tarball to temp location with correct name
  local basename="$(basename "$dest_uri")"
  local local_copy="$tmpdir/$basename"
  cp "$local_path" "$local_copy"

  # Prepare metadata
  cat > "$tmpdir/image-metadata.json" <<JSON
{
  "flake": "${FLAKE_URI}",
  "attribute": "${IMAGE_ATTR}",
  "gitRevision": "$(cd "$REPO_ROOT" && git rev-parse HEAD 2>/dev/null || echo unknown)",
  "createdAt": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
}
JSON

  # Setup gsutil
  local -a gsutil_cmd=(gsutil)
  if [[ -n "$project_id" ]]; then
    gsutil_cmd+=(-o "GSUtil:default_project_id=${project_id}")
  fi

  if [[ $VERBOSE_LEVEL -ge 2 ]]; then
    gsutil_cmd+=(-D)
  fi

  # Setup boto config for parallel uploads
  cat > "$tmpdir/.boto" << 'EOF'
[GSUtil]
parallel_composite_upload_threshold = 150M
EOF

  # Upload tarball with Python warnings suppressed
  if [[ $VERBOSE_LEVEL -ge 1 ]]; then
    log_info "Uploading $(du -h "$local_copy" | cut -f1) tarball to $dest_uri"
  fi

  run_logged "upload-image" "$COLOR_WHITE" \
    env BOTO_CONFIG="$tmpdir/.boto" "${gsutil_cmd[@]}" \
    cp "$local_copy" "$dest_uri"

  # Upload metadata
  local metadata_uri="${dest_uri%.tar.gz}.json"
  if [[ $VERBOSE_LEVEL -ge 1 ]]; then
    log_info "Uploading metadata to $metadata_uri"
  fi

  run_logged "upload-metadata" "$COLOR_WHITE" \
    env BOTO_CONFIG="$tmpdir/.boto" "${gsutil_cmd[@]}" \
    cp "$tmpdir/image-metadata.json" "$metadata_uri"
}

BUILD_ARGS=(
  --attr "$IMAGE_ATTR"
  --remote-host "$REMOTE_HOST"
)

if [[ $VERBOSE_LEVEL -gt 0 ]]; then
  BUILD_ARGS+=(-v "$VERBOSE_LEVEL")
fi

TMPFILE=$(mktemp)
trap 'rm -f "$TMPFILE"' EXIT

if run_logged "build-image" "$COLOR_WHITE" \
    env LOGGING_NO_PREFIX=1 "$SCRIPT_DIR/build-gce-nixos-image.sh" "${BUILD_ARGS[@]}" | tee "$TMPFILE"; then
  TARBALL_PATH=$(grep -o '<TARBALL_PATH>.*</TARBALL_PATH>' "$TMPFILE" | sed 's/<TARBALL_PATH>//g;s/<\/TARBALL_PATH>//g')
  if [[ ! -f "$TARBALL_PATH" ]]; then
    log_error "Build script did not return a valid tarball path: $TARBALL_PATH"
    exit 1
  fi
else
  log_error "Failed to build image"
  exit 1
fi

if [[ $VERBOSE_LEVEL -ge 1 ]]; then
  log_info "Built image: $TARBALL_PATH"
fi

# Upload the image to GCS
upload_to_gcs "$TARBALL_PATH" "$DEST_URI" "$PROJECT_ID"

if [[ "$BUILD_ONLY" == "true" ]]; then
  log_success "Hermes image build and upload complete (skipping deployment)."
  exit 0
fi

pushd "$REPO_ROOT/infra" >/dev/null

if [[ $VERBOSE_LEVEL -ge 1 ]]; then
  log_info "Tainting hermes image resource to force rebuild"
fi
if ! run_logged "taint-image" "$COLOR_WHITE" tofu taint module.hermes.google_compute_image.hermes_nixos; then
  log_info "taint-image skipped (resource may not exist)"
fi

if [[ $VERBOSE_LEVEL -ge 1 ]]; then
  log_info "Tainting hermes instance to force recreation"
fi
if ! run_logged "taint-instance" "$COLOR_WHITE" tofu taint module.hermes.google_compute_instance.hermes; then
  log_info "taint-instance skipped (resource may not exist)"
fi

if [[ $VERBOSE_LEVEL -ge 1 ]]; then
  log_info "Applying terraform configuration with var-file: $TF_VAR_FILE"
fi
run_logged "tofu-apply" "$COLOR_WHITE" tofu apply -auto-approve -var-file="$TF_VAR_FILE"

popd >/dev/null

log_success "Hermes image build and deploy complete."
